<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Kalkulator JR Wellman Jewellery</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0 0 130px 0; background:#f9f9f9; display:flex; flex-direction:column; min-height:100vh; }
    h2 { margin:10px 0; font-size:18px; text-align:center; }
    #sheetSelect { margin:5px auto; padding:6px; font-size:14px; border-radius:6px; width:90%; max-width:300px; }
    table { border-collapse:collapse; width:100%; table-layout:fixed; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden; font-size:13px; word-wrap:break-word; word-break:break-word; }
    thead { background:#007bff; color:white; position:sticky; top:0; z-index:50; }
    thead th { padding:6px; font-size:11px; text-transform:uppercase; }
    tbody td { padding:6px; border-bottom:1px solid #eee; text-align:center; cursor:pointer; font-size:12px; }
    tbody tr:nth-child(even) { background:#f9f9f9; }
    tbody tr:hover td { background:#eaf4ff; }
    td.active { background:#ffe58f !important; font-weight:bold; border:2px solid #f0ad4e; }
    select { padding:5px; font-size:12px; border-radius:6px; width:100%; }
    tbody td:first-child, thead th:first-child { font-weight:bold; }
    #keypad { position:fixed; bottom:0; left:0; right:0; width:100%; background:#f9f9f9; padding:1px; display:grid; grid-template-columns:repeat(3, 1fr); gap:6px; box-shadow:0 -2px 5px rgba(0,0,0,0.15); border-radius:12px 12px 0 0; z-index:1000; }
    #keypad button { padding:14px; font-size:16px; border:none; border-radius:10px; background:#007bff; color:white; cursor:pointer; transition:0.2s; }
    #keypad button:hover { opacity:0.9; }
    #keypad button:active { transform:scale(0.95); }
    #keypad .wide { grid-column:span 3; background:#28a745; }
    #keypad .clear { background:#dc3545; }
    @media (max-width:600px){ h2{font-size:16px;} #sheetSelect{font-size:13px;} thead th,tbody td{font-size:11px;padding:4px;} #keypad button{font-size:14px;padding:12px;} }
    #loadingOverlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; font-size:18px; font-weight:bold; color:#007bff; z-index:2000; }
  </style>
</head>
<body>

<h2>Kalkulator JR Wellman Jewellery</h2>

<select id="sheetSelect" onchange="loadData(this.value)">
  <option value="Sheet1">üìë Harga</option>
  <option value="Sheet2">‚öñÔ∏è Berat</option>
</select>

<table id="sheetTable"></table>

<div id="keypad">
  <button onclick="enterNum(1)">1</button>
  <button onclick="enterNum(2)">2</button>
  <button onclick="enterNum(3)">3</button>
  <button onclick="enterNum(4)">4</button>
  <button onclick="enterNum(5)">5</button>
  <button onclick="enterNum(6)">6</button>
  <button onclick="enterNum(7)">7</button>
  <button onclick="enterNum(8)">8</button>
  <button onclick="enterNum(9)">9</button>
  <button onclick="enterNum('.')">.</button>
  <button onclick="enterNum(0)">0</button>
  <button class="clear" onclick="clearCell()">Clear</button>
  <button class="wide" onclick="saveCell()">üíæ Save</button>
</div>

<div id="loadingOverlay">‚è≥ Sedang memuat data...</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzWuZ2qioohOKEoOixWMAgs-8wEmQZ5SL_mwyc7AFnDgIoAQPjx-HsQ_7Oo5p_nRcjBwA/exec"; 

let selectedCell = null;
let sheetData = [];
let dropdownOptions = {};

// ‚úÖ fungsi format angka ribuan
function formatNumber(num) {
  if (num === "" || num === null || isNaN(num)) return num;
  return Number(num).toLocaleString("id-ID");
}
function parseNumber(str) {
  if (!str) return str;
  return str.toString().replace(/\./g, "");
}

function getHiddenCols(sheet) {
  if (sheet === "Sheet1") {
    return [...Array.from({length:9},(_,i)=>i+5), ...Array.from({length:11},(_,i)=>i+24)];
  } else if (sheet === "Sheet2") {
    return [3,4,5,6,7,8];
  }
  return [];
}

async function loadData(sheet="Sheet1") {
  const overlay = document.getElementById("loadingOverlay");
  overlay.style.display = "flex";
  try {
    let res = await fetch(`${WEB_APP_URL}?sheetName=${sheet}`);
    let json = await res.json();

    if (json.status !== "success") throw new Error(json.message);

    sheetData = json.data;
    dropdownOptions = json.dropdownOptions || {};

    let hiddenCols = getHiddenCols(sheet);
    let table = document.getElementById("sheetTable");
    table.innerHTML = "";

    if (sheetData.length > 0) {
      let thead = document.createElement("thead");
      let headerRow = document.createElement("tr");
      sheetData[0].forEach((h, j) => {
        if (!hiddenCols.includes(j)) {
          let th = document.createElement("th");
          th.innerText = h;
          headerRow.appendChild(th);
        }
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      let tbody = document.createElement("tbody");
      for (let i=1; i<sheetData.length; i++) {
        let tr = document.createElement("tr");
        sheetData[i].forEach((val, j) => {
          if (!hiddenCols.includes(j)) {
            let td = document.createElement("td");

            // ‚úÖ kolom B (index 1) ‚Üí dropdown per baris
            if (j === 1 && dropdownOptions[i+1]) {
              let select = document.createElement("select");
              dropdownOptions[i+1].forEach(opt => {
                let option = document.createElement("option");
                option.value = opt;
                option.text = opt;
                if (opt === val) option.selected = true;
                select.appendChild(option);
              });
              select.onchange = async () => {
                await saveDirect(i+1, j+1, select.value);
                loadData(document.getElementById("sheetSelect").value);
              };
              td.appendChild(select);
            } else {
              // ‚úÖ tampilkan angka dengan format ribuan
              td.innerText = (!isNaN(val) && val !== "") ? formatNumber(val) : val;
              td.onclick = () => selectCell(i+1, j+1, td);
            }

            tr.appendChild(td);
          }
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }
  } catch(err) {
    alert("Gagal load data: " + err);
  } finally {
    overlay.style.display = "none";
  }
}

function selectCell(row, col, td) {
  document.querySelectorAll("td").forEach(x => x.classList.remove("active"));
  td.classList.add("active");
  selectedCell = {row, col, td};
}

function enterNum(num) {
  if (selectedCell && !selectedCell.td.querySelector("select")) {
    let raw = parseNumber(selectedCell.td.innerText || "");
    raw = raw + "" + num;
    selectedCell.td.innerText = formatNumber(raw);
  }
}

function clearCell() {
  if (selectedCell && !selectedCell.td.querySelector("select")) {
    selectedCell.td.innerText = "";
  }
}

async function saveCell() {
  if (selectedCell) {
    let value = selectedCell.td.querySelector("select") 
                  ? selectedCell.td.querySelector("select").value 
                  : parseNumber(selectedCell.td.innerText);
    await saveDirect(selectedCell.row, selectedCell.col, value);
    loadData(document.getElementById("sheetSelect").value);
  } else {
    alert("Pilih cell dulu!");
  }
}

async function saveDirect(row, col, value) {
  try {
    await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({
        sheetName: document.getElementById("sheetSelect").value,
        row: row,
        col: col,
        value: value
      })
    });
  } catch(err) {
    alert("‚ùå Gagal simpan: " + err);
  }
}

loadData("Sheet1");
</script>
</body>
</html>
