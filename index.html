<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Kalkulator JR Wellman Jewellery</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0 0 130px 0; background:#f9f9f9; display:flex; flex-direction:column; min-height:100vh; }
    h2 { margin:10px 0; font-size:18px; text-align:center; }
    #sheetSelect { margin:5px auto; padding:6px; font-size:14px; border-radius:6px; width:90%; max-width:300px; }
    table { border-collapse:collapse; width:100%; table-layout:fixed; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden; font-size:13px; word-wrap:break-word; word-break:break-word; }
    thead { background:#007bff; color:white; position:sticky; top:0; z-index:50; }
    thead th { padding:6px; font-size:11px; text-transform:uppercase; }
    tbody td { padding:6px; border-bottom:1px solid #eee; text-align:center; cursor:pointer; font-size:12px; }
    tbody tr:nth-child(even) { background:#f9f9f9; }
    tbody tr:hover td { background:#eaf4ff; }
    td.active { background:#ffe58f !important; font-weight:bold; border:2px solid #f0ad4e; }
    td.locked { background:#f0f0f0; color:#999; cursor:not-allowed; }
    select { padding:5px; font-size:12px; border-radius:6px; width:100%; }
    tbody td:first-child, thead th:first-child { font-weight:bold; }

    #keypad {
      position:fixed; bottom:0; left:0; right:0; width:100%;
      background:#f9f9f9; padding:4px;
      display:grid; grid-template-columns:repeat(3, 1fr); gap:4px;
      box-shadow:0 -2px 5px rgba(0,0,0,0.15);
      border-radius:10px 10px 0 0; z-index:1000;
    }
    #keypad button {
      padding:8px; font-size:14px; border:none; border-radius:8px;
      background:#007bff; color:white; cursor:pointer; transition:0.2s;
    }
    #keypad button:hover { opacity:0.9; }
    #keypad button:active { transform:scale(0.95); }
    #keypad .wide { grid-column:span 3; background:#28a745; }
    #keypad .clear { background:#dc3545; }
    @media (max-width:600px){
      #keypad button { font-size:12px; padding:6px; }
    }

    #loadingOverlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(255,255,255,0.8);
      display:none; justify-content:center; align-items:center;
      font-size:18px; font-weight:bold; color:#007bff; z-index:2000;
    }
  </style>
</head>
<body>

<h2>Kalkulator JR Wellman Jewellery</h2>

<select id="sheetSelect" onchange="loadData(this.value)">
  <option value="Sheet1">üìë Harga</option>
  <option value="Sheet2">‚öñÔ∏è Berat</option>
</select>

<table id="sheetTable"></table>

<div id="keypad">
  <button onclick="enterNum('1')">1</button>
  <button onclick="enterNum('2')">2</button>
  <button onclick="enterNum('3')">3</button>
  <button onclick="enterNum('4')">4</button>
  <button onclick="enterNum('5')">5</button>
  <button onclick="enterNum('6')">6</button>
  <button onclick="enterNum('7')">7</button>
  <button onclick="enterNum('8')">8</button>
  <button onclick="enterNum('9')">9</button>
  <button onclick="enterNum('.')">.</button>
  <button onclick="enterNum('0')">0</button>
  <button class="clear" onclick="clearCell()">Clear</button>
  <button class="wide" onclick="saveAll()">üíæ Save</button>
</div>

<div id="loadingOverlay">‚è≥ Sedang memuat data...</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzWuZ2qioohOKEoOixWMAgs-8wEmQZ5SL_mwyc7AFnDgIoAQPjx-HsQ_7Oo5p_nRcjBwA/exec"; 

let selectedCell = null;
let sheetData = [];
let dropdownOptions = {};
let editedCells = {};

function formatRupiah(value) {
  if (value === "" || value === null || isNaN(value)) return value;
  return "Rp " + Number(value).toLocaleString("id-ID", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
}

function getHiddenCols(sheet) {
  if (sheet === "Sheet1") {
    return [...Array.from({length:9},(_,i)=>i+5), ...Array.from({length:11},(_,i)=>i+24)];
  } else if (sheet === "Sheet2") {
    return [3,4,5,6,7,8];
  }
  return [];
}

function isLockedCell(sheet, row, col) {
  if (sheet === "Sheet1") {
    // Kolom C terkunci kecuali baris 10 & 18
    if (col === 3 && !(row === 10 || row === 18)) {
      return true;
    }
    // Kolom E terkunci semua kecuali baris 22
    if (col === 5 && row !== 22) {
      return true;
    }
  }
  return false;
}


async function loadData(sheet="Sheet1") {
  const overlay = document.getElementById("loadingOverlay");
  overlay.style.display = "flex";
  try {
    let res = await fetch(`${WEB_APP_URL}?sheetName=${sheet}`);
    let json = await res.json();
    if (json.status !== "success") throw new Error(json.message);

    sheetData = json.data;
    dropdownOptions = json.dropdownOptions || {};
    editedCells = {};

    let hiddenCols = getHiddenCols(sheet);
    let table = document.getElementById("sheetTable");
    table.innerHTML = "";

    if (sheetData.length > 0) {
      let thead = document.createElement("thead");
      let headerRow = document.createElement("tr");
      sheetData[0].forEach((h, j) => {
        if (!hiddenCols.includes(j)) {
          let th = document.createElement("th");
          th.innerText = h;
          headerRow.appendChild(th);
        }
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      let tbody = document.createElement("tbody");
      for (let i=1; i<sheetData.length; i++) {
        let tr = document.createElement("tr");

        if (i+1 === 6 || i+1 === 14) {
          tr.style.fontWeight = "bold";
        }

        sheetData[i].forEach((val, j) => {
          if (!hiddenCols.includes(j)) {
            let td = document.createElement("td");

            if (j === 1 && dropdownOptions[i+1]) {
              let select = document.createElement("select");
              dropdownOptions[i+1].forEach(opt => {
                let option = document.createElement("option");
                option.value = opt;
                option.text = opt;
                if (opt === val) option.selected = true;
                select.appendChild(option);
              });
              select.onchange = async () => {
                let edit = { row: i+1, col: j+1, value: select.value };
                await fetch(WEB_APP_URL, {
                  method: "POST",
                  body: JSON.stringify({
                    sheetName: document.getElementById("sheetSelect").value,
                    edits: [edit]
                  })
                });
                loadData(document.getElementById("sheetSelect").value);
              };
              td.appendChild(select);
            } else {
              if (sheet === "Sheet1") {
                if (j === 3) {
                  td.innerText = val; // Kolom D raw (desimal)
                } else {
                  td.innerText = (!isNaN(val) && val !== "") ? formatRupiah(val) : val;
                }
              } else if (sheet === "Sheet2") {
                td.innerText = val;
              }

              td.onclick = () => {
                if (!isLockedCell(sheet, i+1, j+1)) {
                  selectCell(i+1, j+1, td);
                } else {
                  selectedCell = null;
                }
              };
            }
            tr.appendChild(td);
          }
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }
  } catch(err) {
    alert("Gagal load data: " + err);
  } finally {
    overlay.style.display = "none";
  }
}

function selectCell(row, col, td) {
  document.querySelectorAll("td").forEach(x => x.classList.remove("active"));
  td.classList.add("active");
  selectedCell = {row, col, td};
}

function enterNum(num) {
  if (selectedCell && !selectedCell.td.querySelector("select")) {
    let sheet = document.getElementById("sheetSelect").value;
    if (isLockedCell(sheet, selectedCell.row, selectedCell.col)) return;

    let current = selectedCell.td.innerText.trim();

    if (sheet === "Sheet1" && selectedCell.col === 4) {
      current = current.replace(",", "."); 
      if (num === "." && current.includes(".")) return;
      if (num === "," && current.includes(".")) return;

      let newVal = current + (num === "," ? "." : num);
      selectedCell.td.innerText = newVal;

      editedCells[`${selectedCell.row},${selectedCell.col}`] = {
        row: selectedCell.row, col: selectedCell.col, value: newVal
      };

    } else {
      current = current.replace("Rp","").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,"").trim();
      let newVal = current + num;

      if (!isNaN(newVal) && newVal !== "") {
        selectedCell.td.innerText = formatRupiah(newVal);
      } else {
        selectedCell.td.innerText = newVal;
      }

      editedCells[`${selectedCell.row},${selectedCell.col}`] = {
        row: selectedCell.row, col: selectedCell.col, value: newVal
      };
    }
  }
}

function clearCell() {
  if (selectedCell && !selectedCell.td.querySelector("select")) {
    let sheet = document.getElementById("sheetSelect").value;
    if (isLockedCell(sheet, selectedCell.row, selectedCell.col)) return;

    selectedCell.td.innerText = "";
    editedCells[`${selectedCell.row},${selectedCell.col}`] = {
      row: selectedCell.row, col: selectedCell.col, value: ""
    };
  }
}

async function saveAll() {
  if (Object.keys(editedCells).length === 0) {
    alert("Tidak ada perubahan untuk disimpan.");
    return;
  }
  try {
    await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({
        sheetName: document.getElementById("sheetSelect").value,
        edits: Object.values(editedCells)
      })
    });
    alert("‚úÖ Perubahan tersimpan!");
    loadData(document.getElementById("sheetSelect").value);
  } catch(err) {
    alert("‚ùå Gagal simpan: " + err);
  }
}

loadData("Sheet1");
</script>

</body>
</html>
